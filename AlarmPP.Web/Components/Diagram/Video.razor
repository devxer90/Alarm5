@page "/video"
@using ALARm.Core.Report
@inject AlarmPP.Web.Services.AppData AppData
@inject IMatToaster Toaster

@code {
    private void SetSpeed(int speed)
    {
        PlaybackSpeed = speed;
        GetImage2(CurrentFileId);
    }
}
@code {
    private void OnBadCam3Changed(ChangeEventArgs e)
    {
        BadCam3Mode = e?.Value is bool b && b;
        GetImage2(CurrentFileId);
    }
}

<style>
    .center-guide::after {
        display: none !important;
    }
</style>

<div style="display:flex; flex-direction:row; width:100%; height:100vh; overflow:hidden;">

    <!-- Левая часть -->
    <div style="flex-grow:1; overflow:auto; padding:10px;">
        <MatButton Raised="true" OnClick="ToggleFullScreen" Style="margin-bottom:10px;">
            @(IsFullscreen ? "🔓 Выйти из полного экрана" : "🔒 Полный экран")
        </MatButton>

        <div class="viewer" @ref="ViewerWrapper" tabindex="0">
            @if (!string.IsNullOrEmpty(Base64))
            {
                var rows = N_rows <= 0 ? 1 : N_rows;

                <div class="viewer-inner"
                     @ref="_viewerInnerRef"
                     @onmousedown="OnImageMouseDown"
                     @onmousemove="OnImageMouseMove"
                     @onmousedown:preventDefault="true"
                     @onmousedown:stopPropagation="true">

                    <!-- ЛЕВАЯ линейка (узкая, как раньше) -->
                    <div class="v-ruler v-ruler-left">

                        @* малые деления (каждые 10 см = половина кадра) *@
                        @for (var i = 0; i < rows; i++)
                        {
                            var topSmall = (i + 0.5) * 100.0 / rows;
                            <div class="v-ruler-tick-small" style="top:@topSmall%"></div>
                        }

                        @* основные деления по кадрам (20 см) и метровые *@
                        @for (var i = 0; i <= rows; i++)
                        {
                            var isMeter = (i % 5 == 0);          // 5 кадров = 1 м
                            var top = i * 100.0 / rows;

                            <div class="v-ruler-tick @(isMeter ? "v-ruler-tick-meter" : "")"
                                 style="top:@top%">
                                @if (isMeter)
                                {
                                    <span class="v-ruler-label">@((i / 5.0).ToString("0.#")) м</span>
                                }
                            </div>
                        }
                    </div>

                    <!-- ПРАВАЯ линейка (узкая, как раньше) -->
                    <div class="v-ruler v-ruler-right">

                        @for (var i = 0; i < rows; i++)
                        {
                            var topSmall = (i + 0.5) * 100.0 / rows;
                            <div class="v-ruler-tick-small" style="top:@topSmall%"></div>
                        }

                        @for (var i = 0; i <= rows; i++)
                        {
                            var isMeter = (i % 5 == 0);
                            var top = i * 100.0 / rows;

                            <div class="v-ruler-tick @(isMeter ? "v-ruler-tick-meter" : "")"
                                 style="top:@top%">
                                @if (isMeter)
                                {
                                    <span class="v-ruler-label">@((i / 5.0).ToString("0.#")) м</span>
                                }
                            </div>
                        }
                    </div>

                    <!-- КАРТИНКА -->
                    <img src="data:image/png;base64,@Base64"
                         class="viewer-content" />

                    <!-- ИЗМЕРИТЕЛЬНАЯ ЛИНЕЙКА НА ВСЮ ПАНОРАМУ (по кадрам) -->
                    <div class="v-ruler v-ruler-wide">
                        @* здесь делаем только деления по кадрам и метрам,
                           без мелких 10 см, чтобы не забивать всё линиями *@

                        @for (var i = 0; i <= rows; i++)
                        {
                            var isMeter = (i % 5 == 0);
                            var top = i * 100.0 / rows;

                            <div class="v-ruler-tick @(isMeter ? "v-ruler-tick-meter" : "")"
                                 style="top:@top%"></div>
                        }
                    </div>

                    @*   Диагональная измерительная линия (как у тебя было) *@
                    @if (_isMeasuring || _hasMeasurement)
                    {
                        <svg class="measure-overlay"
                             width="100%"
                             height="100%"
                             preserveAspectRatio="none"
                             xmlns="http://www.w3.org/2000/svg">
                            <line x1="@_startX" y1="@_startY" x2="@_currentX" y2="@_currentY" />
                            <circle cx="@_startX" cy="@_startY" r="4" />
                            <circle cx="@_currentX" cy="@_currentY" r="4" />
                        </svg>

                        @if (!string.IsNullOrEmpty(_measurementLabel))
                        {
                            <div class="measure-label-corner">
                                @_measurementLabel
                            </div>
                        }
                    }


                    <!-- центр HUD -->
                    <div class="center-guide">
                        <div class="frame-badge" title="Текущий кадр">@CurrentVideoFrame</div>

                        <div class="center-hud">
                            <span class="chip">Км: @Number</span>
                            <span class="chip">ПК: @(CurrentMeter / 100 + 1)</span>
                            <span class="chip">М: @CurrentMeter</span>
                            <span class="chip">Кадр: @CurrentVideoFrame</span>
                            <span class="chip">@UiPch</span>
                            <span class="chip">@UiPd</span>
                            <span class="chip">@UiPdp</span>
                            <span class="chip">Код: @UiDirectionCode</span>
                            <span class="chip">Ход: @UiNaprav</span>
                            <span class="chip">Купе: @UiCarPos</span>
                        </div>
                    </div>

                    <!-- Верхний левый HUD -->
                    <div class="viewer-overlay">
                        <span>Км: @Number</span>
                        <span>М: @CurrentMeter</span>
                        <span>ПК: @(CurrentMeter / 100 + 1)</span>
                        <span>@UiPch</span>
                        <span>@UiPd</span>
                        <span>@UiPdp</span>
                        <span>Направление: @UiDirectionName</span>
                        <span>Код: @UiDirectionCode</span>
                        <span>Ход: @UiNaprav</span>
                        <span>Купе: @UiCarPos</span>
                    </div>

                    @if (CamLabels is not null && CamLabels.Length == 5)
                    {
                        <div class="cam-labels dynamic bottom">
                            @foreach (var label in CamLabels)
                            {
                                <div class="cam-label"><span class="tag">@label</span></div>
                            }
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="viewer-content placeholder">Нет изображения</div>
            }
        </div>
    </div>

    <!-- Правая панель (без изменений) -->
    <div style="width:400px; height:100%; overflow-y:auto; padding:10px; background:#f5f5f5; border-left:1px solid #ccc;">
        <h4>Воспроизведение</h4>

        <div style="display:flex; gap:8px; margin:12px 0;">
            <MatButton Raised="true"
                       OnClick="PlayAsync"
                       Disabled="@IsPlaying"
                       Class="@(IsPlaying ? "btn-active" : null)"
                       Style="flex:1;">
                ▶️ Старт
            </MatButton>

            <MatButton Raised="true"
                       OnClick="PauseAsync"
                       Disabled="@(!(IsPlaying || IsRewinding))"
                       Class="@((IsPlaying || IsRewinding) ? "btn-active" : null)"
                       Style="flex:1;">
                ⏸ Пауза
            </MatButton>

            <MatButton Raised="true"
                       OnClick="StartReverseAsync"
                       Disabled="@IsRewinding"
                       Class="@(IsRewinding ? "btn-active" : null)"
                       Style="flex:1;">
                ⏪ Реверс
            </MatButton>
        </div>

        <MatNumericUpDownField @bind-Value="N_rows" Label="Кол-во кадров" />

        <MatNumericUpDownField Value="Number"
                               ValueChanged="@(EventCallback.Factory.Create<int>(this, OnKmChanged))"
                               ValueExpression="@(() => Number)"
                               Label="Километр" />

        <MatNumericUpDownField Value="@_selectedPicket"
                               ValueChanged="@(EventCallback.Factory.Create<int>(this, OnPicketChanged))"
                               ValueExpression="@(()=> _selectedPicket)"
                               Label="Пикет"
                               Min="1" Max="10" />

        <MatNumericUpDownField Value="@_meterInput"
                               ValueChanged="@(EventCallback.Factory.Create<int>(this, OnMeterInputChanged))"
                               ValueExpression="@(()=> _meterInput)"
                               Label="Метр (0–999)"
                               Min="0" Max="999" />

        <p style="margin-top:10px;">
            Метр: @CurrentMeter<br />
            Пикет: @(CurrentMeter / 100 + 1)<br />
            Кадр: @CurrentVideoFrame
        </p>

        <MatButton OnClick="NextClick">Вперёд</MatButton>
        <MatButton OnClick="PrevClick">Назад</MatButton>

        <h4>Скорость</h4>
        <div class="speed-controls" style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;">
            <MatButton OnClick="@(()=>SetSpeed(1))" Raised="true" Dense="true">x1</MatButton>
            <MatButton OnClick="@(()=>SetSpeed(10))" Raised="true" Dense="true">x10</MatButton>
            <MatButton OnClick="@(()=>SetSpeed(20))" Raised="true" Dense="true">x20</MatButton>
            <MatButton OnClick="@(()=>SetSpeed(40))" Raised="true" Dense="true">x40</MatButton>
            <div style="align-self:center;opacity:.7;margin-left:6px;">Текущая: x@PlaybackSpeed</div>
        </div>
        <h4>Качество кадра</h4>

            <label style="
                display:flex;
                align-items:center;
                gap:10px;
                padding:8px;
                background:#fff;
                border:1px solid #ddd;
                border-radius:6px;
                cursor:pointer;
            ">
            <input type="checkbox"
                   checked="@BadCam3Mode"
                   @onchange="OnBadCam3Changed" />

                <span>
                    Cam3 — плохой кадр<br />
                    <small style="opacity:.6">
                        @(BadCam3Mode
                            ? "Включено лечение (поднятие внутри кадра)"
                            : "Нормальный режим (без поднятия)")
                    </small>
                </span>
            </label>

        <div tabindex="0"
             @ref="_hotkeysHost"
             @onkeydown="HandleKeyDown"
             @onkeydown:preventDefault="true"
             @onkeydown:stopPropagation="true"
             class="outline-none select-none"
             style="display:flex;flex-direction:column;align-items:center;gap:8px;padding:6px;border:1px dashed #ddd;border-radius:8px;">
            <label class="text-sm" style="opacity:.7">Шаг (кадров):</label>
            <input type="number" min="0" style="width:90px" @bind="FrameStepOverride" />
            <small style="opacity:.6">0 = использовать N_rows (сейчас: @N_rows)</small>

            <button type="button" class="px-3 py-1 rounded" @onclick="StepPrevHandler">⯅ Prev</button>
            <button type="button" class="px-3 py-1 rounded" @onclick="StepNextHandler">⯆ Next</button>
        </div>
    </div>
</div>





@* смещения
    <MatButton Raised="true" OnClick="() => RestartKm()" Style="margin-top:10px; width:100%;">Обновить</MatButton>
    <hr />

    <h4>Смещения по кадрам</h4>
    <div>
        @for (int i = 0; i < 5; i++)
        {
            var localIndex = i;
            <div style="margin-top:5px;">
                <MatButton OnClick="@(() => RotateFrame(localIndex, 5))" Icon="rotate_right" />
                <span style="font-size:12px;">угол: @RotationAngleByFrame[localIndex]°</span>
            </div>

            <div style="margin-bottom:15px; padding:10px; border:1px solid #ccc; border-radius:8px;">
                <div style="font-weight:bold; text-align:center; margin-bottom:5px;">Кадр @(localIndex + 1)</div>

                <div style="display:flex; justify-content:space-between; gap:15px;">
                    <div style="flex:1; text-align:center;">
                        <MatButton OnClick="@(() => MoveFrameUpSafe(localIndex))" Disabled="@(localIndex == 2)" Icon="arrow_upward" />
                        <div style="margin:4px 0;">Y: <b>@OffsetYByFrame[localIndex]</b> px</div>
                        <MatButton OnClick="@(() => MoveFrameDownSafe(localIndex))" Disabled="@(localIndex == 2)" Icon="arrow_downward" />
                    </div>

                    <div style="flex:1; text-align:center;">
                        <MatButton OnClick="@(() => MoveFrameLeftSafe(localIndex))" Icon="arrow_back" />
                        <div style="margin:4px 0;">X: <b>@OffsetXByFrame[localIndex]</b> px</div>
                        <MatButton OnClick="@(() => MoveFrameRightSafe(localIndex))" Icon="arrow_forward" />
                    </div>
                </div>
            </div>
        }
    </div>

    <hr />

    <MatButton Raised="true" OnClick="SaveOffsetsInMemory" Style="margin-top:10px; width:100%;">
        СОХРАНИТЬ СМЕЩЕНИЯ
    </MatButton> *@
@* <div class="row">
        <div id="imgdiv1" style="padding:10px; width:100%; height:100%; overflow:hidden;">
            <div>
                <MatDialog @bind-IsOpen="@ObjectsDialog" Stacked="true" Style="width:40%; height:30%">
                    <MatDialogTitle>Дефекты пути на @CurrentMeter метре</MatDialogTitle>

                    <MatDialogContent>

                        @* --- Стыковые зазоры ---
                        @if (Gaps != null && Gaps.Count > 0)
                        {
                            <h2>Стыковые зазоры:</h2>
                            <table>
                                <tr>
                                    <th style="border-right:1px solid grey; width:35px;">Км</th>
                                    <th style="border-right:1px solid grey; width:35px;">М</th>
                                    <th style="border-right:1px solid grey; width:110px;">Отступление</th>
                                    <th style="border-right:1px solid grey; width:90px;">Дополнение</th>
                                    <th style="border-right:1px solid grey; width:125px;">Зазоры</th>
                                    <th style="border-right:1px solid grey; width:125px;">Огр. скор.</th>
                                    <th style="border-right:1px solid grey; width:50px;">Балл</th>
                                    <th style="border-right:1px solid grey; width:125px;"></th>
                                </tr>
                                <tbody>
                                    @foreach (var digression in Gaps.Select((value, i) => new { i, value }))
                                    {
                                        <tr>
                                            <td style="border-right:1px solid grey; width:35px;">@Number</td>
                                            <td style="border-right:1px solid grey; width:35px;">@digression.value.Meter</td>
                                            <td style="border-right:1px solid grey; width:110px;">@digression.value.Otst</td>
                                            <td style="border-right:1px solid grey; width:90px;"></td>
                                            <td style="border-right:1px solid grey; width:125px;">
                                                @($"З л:{digression.value.Zazor} З пр:{digression.value.R_zazor}")
                                            </td>
                                            <td style="border-right:1px solid grey; width:125px;">@("Огр.ск: " + digression.value.Vdop)</td>
                                            <th style="border-right:1px solid grey; width:50px;">
                                                @(digression.value.GetPoint() == -1 ? "-" : digression.value.GetPoint())
                                            </th>
                                            <td>
                                                <AlarmButton Text="" Symbol="🗑" Tooltip="Удалить" OnClick="() => DigressionTable.DeleteGapClick(digression.value)"></AlarmButton>
                                                <AlarmButton Text="" Symbol="✏️" Tooltip="Редактировать" OnClick="() => DigressionTable.GetImageGaps(digression.value, digression.i, 1)"></AlarmButton>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        }
                        @* --- Скрепления ---
                        else if (Fasteners != null && Fasteners.Count > 0)
                        {
                            <h2>Скрепления:</h2>
                            <table>
                                <tr>
                                    <th style="border-right:1px solid grey; width:35px;">Км</th>
                                    <th style="border-right:1px solid grey; width:35px;">М</th>
                                    <th style="border-right:1px solid grey; width:110px;">Отступление</th>
                                    <th style="border-right:1px solid grey; width:90px;">Скрепление</th>
                                    <th style="border-right:1px solid grey; width:125px;">Сторона</th>
                                    <th style="border-right:1px solid grey; width:125px;">Балл</th>
                                    <th style="border-right:1px solid grey; width:125px;"></th>
                                </tr>
                                @foreach (var fastener in Fasteners.Select((value, i) => new { i, value }))
                                {
                                    <tr>
                                        <td style="border-right:1px solid grey; width:35px;">@Number</td>
                                        <td style="border-right:1px solid grey; width:35px;">@fastener.value.Mtr</td>
                                        <td style="border-right:1px solid grey; width:110px;">@fastener.value.Otst</td>
                                        <td style="border-right:1px solid grey; width:90px; text-align:right">@fastener.value.Fastening</td>
                                        <td style="border-right:1px solid grey; width:125px;">@fastener.value.Threat_id</td>
                                        <td style="border-right:1px solid grey; width:125px;"></td>
                                        <td>
                                            <AlarmButton Text="" Symbol="🗑" Tooltip="Удалить" OnClick="() => DigressionTable.DeleteFastenerClick(fastener.value)"></AlarmButton>
                                            <AlarmButton Text="" Symbol="✏️" Tooltip="Редактировать" OnClick="() => DigressionTable.ModifyFastenerClick(fastener.value)"></AlarmButton>
                                        </td>
                                    </tr>
                                }
                            </table>
                        }
                        @* --- Болты ---
                        else if (Bolts != null && Bolts.Count > 0)
                        {
                            <h2>Болты:</h2>
                            <table>
                                <tr>
                                    <th style="border-right:1px solid grey; width:35px;">Км</th>
                                    <th style="border-right:1px solid grey; width:35px;">М</th>
                                    <th style="border-right:1px solid grey; width:110px;">Накладка</th>
                                    <th style="border-right:1px solid grey; width:90px;">Дополнение</th>
                                    <th style="border-right:1px solid grey; width:125px;">До стыка</th>
                                    <th style="border-right:1px solid grey; width:125px;">После стыка</th>
                                    <th style="border-right:1px solid grey; width:125px;">Огр. скор.</th>
                                    <th style="border-right:1px solid grey; width:125px;"></th>
                                </tr>
                                @foreach (var bolt in Bolts.Select((value, i) => new { i, value }))
                                {
                                    <tr>
                                        <td style="border-right:1px solid grey; width:35px;">@Number</td>
                                        <td style="border-right:1px solid grey; width:35px;">@bolt.value.Meter</td>
                                        <td style="border-right:1px solid grey; width:110px;">@bolt.value.Overlay</td>
                                        <td style="border-right:1px solid grey; width:90px;"></td>
                                        <td style="border-right:1px solid grey; width:125px;">@bolt.value.Before</td>
                                        <td style="border-right:1px solid grey; width:125px;">@bolt.value.After</td>
                                        <td style="border-right:1px solid grey; width:125px;">@("Огр.ск: " + bolt.value.FullSpeed)</td>
                                        <td>
                                            <AlarmButton Text="" Symbol="🗑" Tooltip="Удалить" OnClick="() => DigressionTable.DeleteBoltClick(bolt.value)"></AlarmButton>
                                            <AlarmButton Text="" Symbol="✏️" Tooltip="Редактировать" OnClick="() => DigressionTable.ModifyBoltClick(bolt.value)"></AlarmButton>
                                            <AlarmButton Text="" Symbol="📷" Tooltip="Фото" OnClick="() => DigressionTable.GetImageBolts(bolt.value, bolt.i, 2)"></AlarmButton>
                                        </td>
                                    </tr>
                                }
                            </table>
                        }
                        @* --- Дефектные шпалы ---
                        else if (DefShpals != null && DefShpals.Count > 0)
                        {
                            <h2>Дефектные шпалы:</h2>
                            <table>
                                <tr>
                                    <th style="border-right:1px solid grey; width:35px;">Км</th>
                                    <th style="border-right:1px solid grey; width:35px;">М</th>
                                    <th style="border-right:1px solid grey; width:110px;">Отступление</th>
                                    <th style="border-right:1px solid grey; width:90px;">Скрепление</th>
                                    <th style="border-right:1px solid grey; width:125px;">Мероприятие</th>
                                    <th style="border-right:1px solid grey; width:125px;">Примечание</th>
                                    <th style="border-right:1px solid grey; width:125px;"></th>
                                </tr>
                                @foreach (var digression in DefShpals.Select((value, i) => new { i, value }))
                                {
                                    <tr>
                                        <td style="border-right:1px solid grey; width:35px;">@Number</td>
                                        <td style="border-right:1px solid grey; width:35px;">@digression.value.Meter</td>
                                        <td style="border-right:1px solid grey; width:110px;">@digression.value.Otst</td>
                                        <td style="border-right:1px solid grey; width:90px;">@digression.value.Fastening</td>
                                        <td style="border-right:1px solid grey; width:125px;">@digression.value.Meropr</td>
                                        <td style="border-right:1px solid grey; width:125px;">@digression.value.Notice</td>
                                        <td>
                                            <AlarmButton Text="" Symbol="🗑" Tooltip="Удалить" OnClick="() => DigressionTable.DeleteDefShpalClick(digression.value)"></AlarmButton>
                                            <AlarmButton Text="" Symbol="✏️" Tooltip="Редактировать" OnClick="() => DigressionTable.ModifyDefShpalClick(digression.value)"></AlarmButton>
                                        </td>
                                    </tr>
                                }
                            </table>
                        }
                        @* --- Перпендикулярные шпалы ---
                        else if (PerShpals != null && PerShpals.Count > 0)
                        {
                            <h2>Перпендикулярные шпалы:</h2>
                            <table>
                                <tr>
                                    <th style="border-right:1px solid grey; width:35px;">Км</th>
                                    <th style="border-right:1px solid grey; width:35px;">М</th>
                                    <th style="border-right:1px solid grey; width:110px;">Отступление</th>
                                    <th style="border-right:1px solid grey; width:90px;">Градус</th>
                                    <th style="border-right:1px solid grey; width:125px;">Скрепление</th>
                                    <th style="border-right:1px solid grey; width:125px;">Примечание</th>
                                    <th style="border-right:1px solid grey; width:125px;"></th>
                                </tr>
                                @foreach (var digression in PerShpals.Select((value, i) => new { i, value }))
                                {
                                    <tr>
                                        <td style="border-right:1px solid grey; width:35px;">@Number</td>
                                        <td style="border-right:1px solid grey; width:35px;">@digression.value.Meter</td>
                                        <td style="border-right:1px solid grey; width:110px;">@digression.value.Otst</td>
                                        <td style="border-right:1px solid grey; width:90px;">@digression.value.Angle.ToString("0.00")</td>
                                        <td style="border-right:1px solid grey; width:125px;">@digression.value.Fastener</td>
                                        <td style="border-right:1px solid grey; width:125px;"></td>
                                        <td>
                                            <AlarmButton Text="" Symbol="🗑" Tooltip="Удалить" OnClick="() => DigressionTable.DeletePerShpalClick(digression.value)"></AlarmButton>
                                            <AlarmButton Text="" Symbol="✏️" Tooltip="Редактировать" OnClick="() => DigressionTable.ModifyPerShpalClick(digression.value)"></AlarmButton>
                                        </td>
                                    </tr>
                                }
                            </table>
                        }

                    </MatDialogContent>

                    <MatDialogActions>
                        <MatButton Raised="true" OnClick="_=> { ObjectsDialog = false; }">Закрыть</MatButton>
                    </MatDialogActions>
                </MatDialog>
            </div>
        </div>
    </div> *@